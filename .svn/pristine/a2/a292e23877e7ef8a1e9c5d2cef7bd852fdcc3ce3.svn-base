package com.wolfking.jeesite.modules.md.service;

import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.kkl.kklplus.utils.StringUtils;
import com.wolfking.jeesite.common.persistence.LongIDBaseEntity;
import com.wolfking.jeesite.common.service.LongIDBaseService;
import com.wolfking.jeesite.modules.api.entity.common.RestCommonIds;
import com.wolfking.jeesite.modules.api.entity.md.RestMaterial;
import com.wolfking.jeesite.modules.api.entity.md.RestProduct;
import com.wolfking.jeesite.modules.api.util.RestResult;
import com.wolfking.jeesite.modules.api.util.RestResultGenerator;
import com.wolfking.jeesite.modules.md.entity.Material;
import com.wolfking.jeesite.modules.md.entity.Product;
import com.wolfking.jeesite.modules.md.entity.ProductCategory;
import com.wolfking.jeesite.ms.providermd.service.MSProductCategoryNewService;
import com.wolfking.jeesite.ms.providermd.service.MSProductService;
import lombok.extern.slf4j.Slf4j;
import ma.glasnost.orika.MapperFacade;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.RequestBody;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
@Transactional(propagation = Propagation.NOT_SUPPORTED)
@Slf4j
public class ProductService extends LongIDBaseService {
    @SuppressWarnings("rawtypes")
    @Autowired
    public RedisTemplate redisTemplate;

    @Autowired
    private MapperFacade mapper;

    @Autowired
    private MSProductCategoryNewService msProductCategoryNewService;

    @Autowired
    private MSProductService msProductService;

    @Autowired
    private MaterialService materialService;

    /**
     * 拆分套组产品，返回组成产品列表
     *
     * @param id 套组产品id
     */
    public List<Product> getProductListOfSet(Long id) {
        List<Product> list = Lists.newArrayList();
        if (id == null || id <= 0) {
            return list;
        }
        Product pset = getProductByIdFromCache(id);
        if (pset == null || StringUtils.isBlank(pset.getProductIds())) {
            return list;
        }
        String[] ids = pset.getProductIds().split(",");
        String pid = new String("");
        for (int i = 0, size = ids.length; i < size; i++) {
            pid = ids[i];
            if (StringUtils.isBlank(pid)) {
                continue;
            }
            Product p = getProductByIdFromCache(Long.valueOf(pid));
            if (p != null) {
                list.add(p);
            }
        }
        return list;
    }

    /**
     * 根据产品ID获取配件列表
     *
     * @param productId
     * @return
     */
    public List<RestMaterial> getMaterialByProductId(Long productId) {
		/*boolean isExistsCache = redisUtils.exists(RedisConstant.RedisDBType.REDIS_MD_DB, RedisConstant.MD_PRODUCT);
		if (!isExistsCache){
			loadProductDataFromDB2Cache(LoadProductType.ALL);
		}
		List<RestMaterial> materialList = Lists.newArrayList();
		List<Long> materialIds = redisUtils.zRange(RedisConstant.RedisDBType.REDIS_MD_DB, String.format(RedisConstant.MD_PRODUCT_MATERIAL, productId),0,-1, Long.class);
		Material material;
		for (Long materialId : materialIds){
			material = (Material) redisUtils.zRangeOneByScore(RedisConstant.RedisDBType.REDIS_MD_DB, RedisConstant.MD_MATERIAL_ALL, materialId, materialId, Material.class);
			materialList.add(mapper.map(material, RestMaterial.class));
		}
		return materialList;*/
        //调用微服务 start on 2019-9-17
        List<RestMaterial> restMaterialList = Lists.newArrayList();
        List<Material> materialList = materialService.getMaterialListByProductId(productId);
        if (materialList != null && materialList.size() > 0) {
            restMaterialList = mapper.mapAsList(materialList, RestMaterial.class);
        }
        return restMaterialList;
    }


    //region redis操作

    /**
     * 从缓存读取产品信息，当缓存未命中则从数据库装载至缓存
     *
     * @param id
     * @return
     */
    public Product getProductByIdFromCache(Long id) {
        // mark on 2020-2-11
		/*boolean isExistsCache = redisUtils.exists(RedisConstant.RedisDBType.REDIS_MD_DB, RedisConstant.MD_PRODUCT);
		if (!isExistsCache){
			loadProductDataFromDB2Cache(LoadProductType.ALL);
		}
		return redisUtils.hGet(RedisConstant.RedisDBType.REDIS_MD_DB, RedisConstant.MD_PRODUCT, id.toString(), Product.class);*/
        Product product = msProductService.getProductByIdFromCache(id);
        if (product != null && product.getCategory() != null && product.getCategory().getId() > 0) {
			/*
			ProductCategory productCategory = msProductCategoryService.getFromCache(product.getCategory().getId());
			if(productCategory!=null){
				product.getCategory().setName(productCategory.getName());
			}
			*/
            //product.getCategory().setName(msProductCategoryService.getNameFromCache(product.getCategory().getId()));  //mark on 2020-4-1
            product.getCategory().setName(msProductCategoryNewService.getFromCacheForMD(product.getCategory().getId())); //add on 2020-4-1
            return product;
        } else {
            return null;
        }
    }

    /**
     * 加载所有产品，当缓存未命中则从数据库装载至缓存
     *
     * @return
     */
    public List<Product> findAllList() {
		/*boolean isExistsCache = redisUtils.exists(RedisConstant.RedisDBType.REDIS_MD_DB, RedisConstant.MD_PRODUCT);
		if (!isExistsCache){
			return loadProductDataFromDB2Cache(LoadProductType.ALL);
		}

		List<Long> productIds = redisUtils.zRange(RedisConstant.RedisDBType.REDIS_MD_DB, RedisConstant.MD_PRODUCT_ALL,0,-1, Long.class);
		List<Product> productList = Lists.newArrayList();
		Iterator<Long> it = productIds.iterator();
		while(it.hasNext()){
			Long productId = it.next();
			productList.add(redisUtils.hGet(RedisConstant.RedisDBType.REDIS_MD_DB, RedisConstant.MD_PRODUCT, productId.toString(), Product.class));
		}*/
        //return productList;
        List<Product> productList = msProductService.findAllList();
        return handleProductCategory(productList);
    }

    public Map<Long, Product> getProductMap(List<Long> ids) {
        if (ids == null || ids.isEmpty()) {
            return Maps.newHashMap();
        }
        List<Product> list = msProductService.findProductByIdListFromCache(ids);
        handleProductCategory(list);
        Map<Long, Product> productMap = list.stream().collect(Collectors.toMap(LongIDBaseEntity::getId, i -> i));
        return productMap;
    }


    /**
     * 加载非套组产品，当缓存未命中则从数据库装载至缓存
     *
     * @return
     */
    public List<Product> getSingleProductList() {
        // 调用微服务 add on 2020-2-11
        List<Product> productListAll = msProductService.findAllList();
        if (productListAll != null && productListAll.size() > 0) {
            List<Product> singleProductList = productListAll.stream().filter(t -> t.getSetFlag() == 0).collect(Collectors.toList());
            return handleProductCategory(singleProductList);
        } else {
            return Lists.newArrayList();
        }
    }

    //region api functions
    public RestResult<Object> getProductMaterialList(@RequestBody RestCommonIds commonIds) {
        List<RestProduct> productMaterials = Lists.newArrayList();
        for (String id : commonIds.getIds()) {
            Long productId = Long.valueOf(id);
            RestProduct restProduct = new RestProduct();
            restProduct.setId(id);
            restProduct.setMaterials(getMaterialByProductId(productId));
            productMaterials.add(restProduct);
        }
        return RestResultGenerator.success(productMaterials);
    }
    //endregion api functions


    /**
     * 处理产品中的产品分类
     *
     * @param productList
     * @return
     */
    private List<Product> handleProductCategory(List<Product> productList) {
        if (productList == null) {
            return Lists.newArrayList();
        }
        // ProductCategory微服务调用
        //List<ProductCategory> productCategoryList = msProductCategoryService.findAllList();
        List<Long> ids = productList != null && !productList.isEmpty() ? productList.stream().map(x -> x.getCategory().getId()).distinct().collect(Collectors.toList()) : Lists.newArrayList();
        //List<ProductCategory> productCategoryList = ids!= null && !ids.isEmpty()? msProductCategoryService.findListByIds(ids):Lists.newArrayList();  //mark on 2020-4-1
        List<ProductCategory> productCategoryList = ids != null && !ids.isEmpty() ? msProductCategoryNewService.findListByIdsForMDWithEntity(ids) : Lists.newArrayList(); //add on 2020-4-1
        Map<Long, ProductCategory> productCategoryMap = Maps.newHashMap();
        if (productCategoryList != null && !productCategoryList.isEmpty()) {
            productCategoryMap = productCategoryList.stream().collect(Collectors.toMap(ProductCategory::getId, r -> r));
        }

        Map<Long, ProductCategory> finalProductCategoryMap = productCategoryMap;
        productList.stream().forEach(product -> {
            ProductCategory productCategory = finalProductCategoryMap.get(product.getCategory().getId());
            product.getCategory().setName(productCategory == null ? "" : productCategory.getName());
        });

        return productList;
    }
}
